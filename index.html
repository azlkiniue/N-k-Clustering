<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <script src="js/jquery-3.1.1.min.js"></script>
        <script src="js/popper.min.js"></script>
        <script src="js/bootstrap.min.js"></script>
        <script src="js/d3.js"></script>
        <script src="js/math.min.js"></script>
        <script src="js/plotly.min.js"></script>
    </head>
    <script>
        var psv = d3.dsvFormat(",");
        var filesDirectory = 'file/';
        var kNumber = 3;
        var labels;

        // ambil daftar file 
        $.ajax({url: filesDirectory}).then(function(html) {

            // create temporary DOM element
            var document = $(html);

            // find all links ending with .pdf 
            document.find('a[href$=".txt"]').each(function() {
                var fileName = $(this).text();
                var fileUrl = $(this).attr('href');

                // do what you want here
                $(".dropdown-menu").append("<a href='#' class='dropdown-item' onclick='clusterize(\"" + fileName + "\")'>" + fileName + "</a>");
            })
        });
        // inisialisasi proses clustering
        function clusterize(fileName) {
            d3variable = d3.request(filesDirectory + fileName)
            .mimeType("text/plain")
            .response(function(xhr) { return psv.parse(xhr.responseText) });
            d3result = d3variable.get(function(data) {
                table = {}; population = []; ansPop = [];
                labels = Object.keys(data[0]);
                answer = labels.pop();
                Object.keys(data[0]).forEach(label => {
                    table[label] = [];
                });
                data.forEach(row => {
                    let insidePop = {}, ansVal; //insidePop = variabel object yang ada di dalam variabel population; ansval = self-explanatory
                    Object.keys(row).forEach(label => {
                        table[label].push(Number(row[label]));
                        if (label != answer) {
                            insidePop[label] = Number(row[label]);
                        }else{
                            ansVal = row[label];
                        }
                    });
                    ansPop.push(ansVal);
                    population.push(insidePop);
                });
                // initializeDisplay();
                initializeDistance();
            });
        }
        
        //distance initialization (N*N)
        function initializeDistance() {
            distance = [];
            population.forEach((rowParent, key) => {
                let insideDistance = [];
                population.forEach(rowChild => {
                    let distVal = getDistance(rowParent, rowChild);
                    insideDistance.push(distVal);
                });
                insideDistance[key] = null;
                distance.push(insideDistance);
            });
        }

        function getDistance(a, b) {
            let distVal, totalDistance = 0;
            labels.forEach(label => {
                totalDistance += Math.pow((a[label] - b[label]), 2);
            });
            distVal = Math.sqrt(totalDistance);
            return distVal;
        }

        function process() {
            //initializeDistance();
            
            //initialize cluster
            cluster = [[]];
            population.forEach((row, key) => {
                cluster[0].push([key]);
            });
            let iter = 0;
            while (cluster[iter].length > kNumber) {
                let hasil = findNearest(iter);
                mergeCluster(iter, hasil.result);
                console.log(++iter);
            }
        }

        function findNearest(iter) {
            let nearest = {}; //nearest punya properti: value, key (index array yang memuat)
            nearest.val = Number.MAX_SAFE_INTEGER; //inisialisasi min value
            let tempDistance;
            cluster[iter].forEach((rowParent, keyParent) => {
                let centroParent = getCentroid(rowParent);
                cluster[iter].forEach((rowChild, keyChild) => {
                    if (keyParent != keyChild) { //centroid linkage
                        let centroChild = getCentroid(rowChild);
                        tempDistance = getDistance(centroParent, centroChild);
                        if (tempDistance < nearest.val) {
                            nearest.val = tempDistance;
                            nearest.result = [keyParent, keyChild];
                        }
                    }
                });
            });

            return nearest;

            function getCentroid(clustArray) {
                let average = {}; //variabel centroid yang akan di-return
                if (clustArray.length == 1) { //skip jika cluster cuma isi 1
                    return population[clustArray[0]];
                }
                clustArray.forEach(data =>{
                    labels.forEach(label =>{
                        if (!(label in average)) {
                            average[label] = [population[data][label]];
                        } else {
                            average[label].push(population[data][label]);
                        }
                    });
                });

                labels.forEach(label => {
                    average[label] = math.mean(average[label]);
                });
                
                return average;
            }  
        }
        
        function mergeCluster(iter, result) {
            cluster[iter + 1] = [];
            cluster[iter].forEach((row, key) => {
                if (result.indexOf(key) == -1) {
                    cluster[Number(iter) + 1].push(row);
                }
            });
            cluster[Number(iter) + 1].push(cluster[iter][result[0]].concat(cluster[iter][result[1]]));
        }

        function errorRatioCalculation()
        {
            let finalCluster = cluster[cluster.length - 1];
            let firstCondition = [ "Iris-setosa", "Iris-versicolor", "Iris-virginica"];
            let secondCondition = [ "Iris-versicolor", "Iris-setosa", "Iris-virginica"];
            let thirdCondition = [ "Iris-versicolor", "Iris-virginica", "Iris-setosa"];
            let fourthCondition = [ "Iris-virginica", "Iris-setosa", "Iris-versicolor"];
            let fifthCondition = [ "Iris-setosa", "Iris-virginica","Iris-versicolor"];
            let sixthCondition = [ "Iris-virginica", "Iris-versicolor", "Iris-setosa"];

            let firstConditionFail = 0;
            let secondConditionFail = 0;
            let thirdConditionFail = 0;
            let fourthConditionFail = 0;
            let fifthConditionFail = 0;
            let sixthConditionFail = 0;

            finalCluster.forEach((row, key) => {
                finalCluster[key].forEach((i, j) => {
                    /*console.log('---------------------');
                    console.log(i);
                    console.log(ansPop[i]);
                    console.log(firstCondition[key]);
                    console.log("---------------------");*/
                    if(ansPop[i] != firstCondition[key]){
                        firstConditionFail++;
                    }

                    if(ansPop[i] != secondCondition[key]){
                        secondConditionFail++;
                    }

                    if(ansPop[i] != thirdCondition[key]){
                        thirdConditionFail++;
                    }

                    if(ansPop[i] != fourthCondition[key]){
                        fourthConditionFail++;
                    }

                    if(ansPop[i] != fifthCondition[key]){
                        fifthConditionFail++;
                    }

                    if(ansPop[i] != sixthCondition[key]){
                        sixthConditionFail++;
                    }

                });
            });
            
            let minimumFail = 1000;

            let firstConditionValue = ((firstConditionFail/population.length) * 100).toFixed(2);
            console.log("Kombinasi 1 : "+firstConditionFail+" kesalahan dari "+population.length+" data, nilai "+ firstConditionValue+" %");

            if(firstConditionFail < minimumFail){
                minimumFail = firstConditionFail;
            }

            let secondConditionValue = ((secondConditionFail/population.length) * 100).toFixed(2);
            console.log("Kombinasi 2 : "+secondConditionFail+" kesalahan dari "+population.length+" data, nilai "+ secondConditionValue+" %");
            
            if(secondConditionFail < minimumFail){
                minimumFail = secondConditionFail;
            }

            let thirdConditionValue = ((thirdConditionFail/population.length) * 100).toFixed(2);
            console.log("Kombinasi 3 : "+thirdConditionFail+" kesalahan dari "+population.length+" data, nilai "+ thirdConditionValue+" %");
            
            if(thirdConditionFail < minimumFail){
                minimumFail = thirdConditionFail;
            }

            let fourthConditionValue = ((fourthConditionFail/population.length) * 100).toFixed(2);
            console.log("Kombinasi 4 : "+fourthConditionFail+" kesalahan dari "+population.length+" data, nilai "+ fourthConditionValue+" %");
            
            if(fourthConditionFail < minimumFail){
                minimumFail = fourthConditionFail;
            }

            let fifthConditionValue = ((fifthConditionFail/population.length) * 100).toFixed(2);
            console.log("Kombinasi 5 : "+fifthConditionFail+" kesalahan dari "+population.length+" data, nilai "+ fifthConditionValue+" %");
            
            if(fifthConditionFail < minimumFail){
                minimumFail = fifthConditionFail;
            }

            let sixthConditionValue = ((sixthConditionFail/population.length) * 100).toFixed(2);
            console.log("Kombinasi 6 : "+sixthConditionFail+" kesalahan dari "+population.length+" data, nilai "+ sixthConditionValue+" %");

            if(sixthConditionFail < minimumFail){
                minimumFail = sixthConditionFail;
            }

            console.log("========================================================================");
            console.log("Error ratio dari clustering ini sebesar : "+ ((minimumFail/population.length)*100).toFixed(2) +" %");

        }

    </script>
    <body onload="clusterize('iris.txt')"></body>
        <!-- <div class="container">
            <div class="jumbotron">
                <h1 class="display-3">Metode K - Means</h1>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Pilih File</button>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton"></div>
            </div><br>
            <div class="card">
                <div class="card-body text-capitalize">
                    <div id="init"></div>
                    <br>
                    <div class="form-inline">
                        <label for="input" style="margin-right: 15px">K-Number: </label>
                        <input class="form-control" type="number" id="input" min="1" value="4" style="margin-right: 15px">
                        <input class="btn btn-secondary" type="button" value="Proses" id="submit" onclick="process()">
                    </div><br>
                    <div id="result"></div>
                    <button type="button" id="analysis" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal" onclick="clusterVariance()" hidden>Cluster Analysis</button>
                </div>
            </div>
            <!-- Modal
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Cluster Analysis</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        </div>
                        <div class="modal-body">
                            <ul class="list-group">
                            </ul>
                        </div>
                        <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">OK</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body> -->
    <script>
        $("#input").on("keyup","span",function(event){
            if(event.keyCode == 13){
                getNeighbour();
            }
        });
        // $("#input").keydown(function (e) {
        //     e.preventDefault();
        // })
        // $("#input").change(function (params) {
        //     kNumber = Number($("#input").val());
        // })
        
    </script>
</html>